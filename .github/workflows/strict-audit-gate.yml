name: Strict Forbidden References Gate

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  strict-audit:
    name: Zero Forbidden References Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Install ripgrep
      run: |
        sudo apt-get update
        sudo apt-get install -y ripgrep
    
    - name: Create audit directory
      run: mkdir -p .audit
    
    - name: Run strict repository scan
      id: repo-scan
      run: |
        echo "=== STRICT AUDIT REPORT ===" > .audit/audit-report.txt
        echo "Commit: $(git rev-parse HEAD)" >> .audit/audit-report.txt
        echo "Date: $(date -u)" >> .audit/audit-report.txt
        echo "" >> .audit/audit-report.txt
        echo "=== REPOSITORY SCAN (no exclusions) ===" >> .audit/audit-report.txt
        echo "" >> .audit/audit-report.txt
        
        # Run scan and capture output
        if rg -n --hidden --no-ignore --glob '!.git/**' -i \
          "(solana|solanalabs|solana[-_ ]foundation|\\bspl\\b|\\bsol\\b|anza|agave|coral\\.xyz|solana\\.com|release\\.anza\\.xyz|gs://anza-release|anzaxyz/|buildkite/agave|anza/agave)" \
          . >> .audit/audit-report.txt 2>&1; then
          echo "FORBIDDEN REFERENCES FOUND" >> .audit/audit-report.txt
          MATCH_COUNT=$(rg -n --hidden --no-ignore --glob '!.git/**' -i "(solana|solanalabs|solana[-_ ]foundation|\\bspl\\b|\\bsol\\b|anza|agave|coral\\.xyz|solana\\.com|release\\.anza\\.xyz|gs://anza-release|anzaxyz/|buildkite/agave|anza/agave)" . | wc -l)
          echo "Match count: $MATCH_COUNT" >> .audit/audit-report.txt
          echo "result=FAIL" >> $GITHUB_OUTPUT
          echo "count=$MATCH_COUNT" >> $GITHUB_OUTPUT
        else
          echo "No matches found (PASS)" >> .audit/audit-report.txt
          echo "Match count: 0" >> .audit/audit-report.txt
          echo "result=PASS" >> $GITHUB_OUTPUT
          echo "count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Upload audit report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: strict-audit-report
        path: .audit/audit-report.txt
        retention-days: 90
    
    - name: Check audit result
      if: steps.repo-scan.outputs.result == 'FAIL'
      run: |
        echo "::error::Strict audit FAILED: Found ${{ steps.repo-scan.outputs.count }} forbidden references"
        cat .audit/audit-report.txt
        exit 1
    
    - name: Audit passed
      if: steps.repo-scan.outputs.result == 'PASS'
      run: |
        echo "âœ… Strict audit PASSED: Zero forbidden references found"
        cat .audit/audit-report.txt
